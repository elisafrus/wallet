name: Continuous Deployment

on:
  push:
    branches: [main] # Запускати лише при коміті в основну гілку (після злиття PR)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---------------------------------------------
      # 1. Збірка фінальних артефактів
      # ---------------------------------------------
      - name: Install Dependencies and Build
        run: |
          npm install
          npm run build # Фінальна збірка

      # ===============================================
      # 2. СИМУЛЯЦІЯ: Розгортання на Стейдж-сервері
      # (Замінює SSH-Deploy та не вимагає GitHub Secrets)
      # ===============================================
      - name: Simulate Deployment to Staging Server
        run: |
          echo "================================================="
          echo "INFO: Simulation Mode Activated."
          echo "INFO: Deployment package prepared for staging server."
          echo "INFO: Copying artifacts to /var/www/wallet-staging-server/..."
          echo "INFO: Deployment completed successfully on $(date)."
          echo "================================================="

      # ===============================================
      # 3. СИМУЛЯЦІЯ: Перезапуск сервісу на сервері
      # (Замінює SSH-Action для перезапуску PM2)
      # ===============================================
      - name: Simulate Application Restart and Health Check
        run: |
          echo "INFO: Logging in to remote server (simulated)..."
          echo "INFO: Running npm install --production on staging server."
          echo "INFO: Service 'wallet-app' restarted via PM2 successfully."
          echo "INFO: Staging application is now live with the latest code."